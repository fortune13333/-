# 链踪：添加新设备指南 (V2.0 - 使用 config.ini)

欢迎使用链踪！本指南将详细说明如何将一台新的网络设备添加到您的链踪监控系统中。新版本的工作流程已大大简化，您只需编辑配置文件即可。

添加新设备是一个分为两部分的过程：**① 更新 `config.ini` 文件** 和 **② 在Web应用界面中创建设备**。

---

## 核心概念：设备ID是关键链接

在开始之前，请务必理解一个核心概念：**设备ID (Device ID)**。

设备ID是一个您自定义的、独一无二的字符串（例如 `CORE-SW-BEIJING`）。它就像一座桥梁，将Web应用中的设备记录与本地代理中配置的真实设备连接信息精确地对应起来。

**规则：** 在Web应用中输入的`设备ID`**必须**与在`config.ini`中设置的`设备ID`**完全一致**（大小写不敏感，但建议保持一致）。

---

## 第 1 部分：在 `config.ini` 中“注册”新设备

首先，我们需要告诉本地代理如何连接到您的新设备。

### 步骤 1: 定位并编辑 `config.ini`

1.  在您的本地代理文件夹中，找到并用文本编辑器打开 `config.ini` 文件。
2.  在文件中找到名为 `[device_map]` 的部分。它看起来像这样：

    ```ini
    ; ... (上面的凭据部分) ...

    [device_map]
    ; 格式: WEB应用中的设备ID = IP地址, Netmiko设备类型
    RTR01-NYC = 192.168.1.1, cisco_ios
    SW01-SFO = 10.10.5.254, cisco_ios
    ```

### 步骤 2: 添加新设备条目

在 `[device_map]` 部分下，为您要添加的新设备添加**新的一行**。

**示例：** 假设我们要添加一台位于北京的华为核心交换机。

```ini
[device_map]
; 格式: WEB应用中的设备ID = IP地址, Netmiko设备类型
RTR01-NYC = 192.168.1.1, cisco_ios
SW01-SFO = 10.10.5.254, cisco_ios
CORE-SW-BEIJING = 10.0.0.1, huawei_vrp
```

-   `CORE-SW-BEIJING`: 这是我们为新设备设定的**唯一设备ID**。请牢记它。
-   `10.0.0.1`: 替换为您设备的**真实IP地址**或可解析的主机名。
-   `huawei_vrp`: 设备的类型。这**必须**是 [Netmiko 库支持的类型](https://github.com/ktbyers/netmiko/blob/develop/README.md#supports)。
    -   常见类型包括: `cisco_ios`, `cisco_xr`, `juniper_junos`, `huawei_vrp`, `arista_eos`, `cisco_asa` 等。

### 步骤 3: 保存并重启代理

1.  **保存**您对 `config.ini` 文件的修改。
2.  回到您正在运行代理的终端窗口，按 `Ctrl+C` 停止当前进程。
3.  重新运行启动命令，以加载新的设备配置：
    ```bash
    uvicorn agent:app --reload
    ```
    如果您使用的是打包好的 `agent.exe`，请先在任务管理器中结束它，然后重新双击运行。

---

## 第 2 部分：在Web应用界面中创建设备

现在，我们让链踪Web应用知道这个新设备的存在。

### 步骤 1: 打开“添加新设备”窗口

1.  在浏览器中打开链踪Web应用。
2.  导航到**任意一个**已存在的设备详情页面。
3.  在设备切换下拉框的旁边，找到并点击 **“+”** (加号)按钮。

### 步骤 2: 填写设备信息

在弹出的窗口中，填写新设备的信息：

-   **设备 ID**:
    -   **(最关键的一步!)** 输入您在 `config.ini` 中设置的那个**完全相同**的ID。
    -   在我们的示例中，这里应该填 `CORE-SW-BEIJING`。

-   **设备名称**:
    -   一个易于理解的友好名称，例如 `北京核心交换机`。

-   **IP 地址**:
    -   填写设备的真实IP地址，例如 `10.0.0.1`。此IP主要用于在界面上显示。

-   **设备类型**:
    -   从下拉菜单中选择一个最符合的类型（路由器、交换机、防火墙）。

### 步骤 3: 完成添加

点击**“添加设备”**按钮。

---

## ✅ 验证与完成

操作完成后，您的新设备会立即出现在设备切换的下拉列表中，并拥有一个“创世区块”。

**强烈建议：** 切换到您的新设备，然后点击**“从设备获取”**按钮来测试整个链路是否工作正常。如果配置被成功拉取到文本框中，恭喜您，添加成功！

## 🔧 故障排除

-   **问题**: 点击“从设备获取”时提示 `Device ID not found`。
    -   **解决方案**: 检查Web应用中显示的设备ID是否与`config.ini`中的ID**完全一致**。确认您已经**重启了本地代理**。

-   **问题**: 提示 `Connection timed out` 或 `Authentication failed`。
    -   **解决方案**:
        1.  检查 `config.ini` 中的 `host` IP地址是否正确，并且运行代理的电脑可以访问到该IP。
        2.  检查 `config.ini` 中的 `username` 和 `password` 是否正确。
        3.  检查是否有网络防火墙阻止了从代理到设备的SSH连接（默认端口22）。
