# 链踪：添加新设备指南 (V1.0)

欢迎使用链踪！本指南将详细说明如何将一台新的、真实的物理网络设备添加到您的链踪监控系统中。

添加新设备是一个分为两部分的过程，需要同时配置**① 本地代理**和**② Web应用界面**。请仔细按照以下步骤操作。

---

## 核心概念：设备ID是关键链接

在开始之前，请务必理解一个核心概念：**设备ID (Device ID)**。

设备ID是一个您自定义的、独一无二的字符串（例如 `CORE-SW-BEIJING`）。它就像一座桥梁，将Web应用中的设备记录与本地代理中配置的真实设备连接信息精确地对应起来。

**规则：** 在Web应用中输入的`设备ID`**必须**与在`agent.py`中设置的`设备ID`**完全一致**，包括大小写。

---

## 第 1 部分：在本地代理中“注册”新设备

首先，我们需要告诉本地代理如何连接到您的新设备。

### 步骤 1: 定位并编辑 `agent.py`

1.  在您的本地代理文件夹中，找到并用代码编辑器打开 `agent.py` 文件。
2.  在文件中找到名为 `DEVICE_MAP` 的Python字典。它看起来像这样：

    ```python
    # ... (前面的代码) ...

    DEVICE_MAP = {
        "RTR01-NYC": {
            "host": "192.168.1.1",
            "device_type": "cisco_ios",
        },
        "SW01-SFO": {
            "host": "10.10.5.254",
            "device_type": "cisco_ios",
        },
        # 在这里添加或修改您的其他设备...
    }

    # ... (后面的代码) ...
    ```

### 步骤 2: 添加新设备条目

在 `DEVICE_MAP` 字典中，为您要添加的新设备添加一个条目。

**示例：** 假设我们要添加一台位于北京的华为核心交换机。

```python
DEVICE_MAP = {
    "RTR01-NYC": {
        "host": "192.168.1.1",
        "device_type": "cisco_ios",
    },
    "SW01-SFO": {
        "host": "10.10.5.254",
        "device_type": "cisco_ios",
    },
    # --- 在这里添加您的新设备 ---
    "CORE-SW-BEIJING": {
        "host": "10.0.0.1",
        "device_type": "huawei_vrp",
    },
    # ---------------------------
}
```

-   `"CORE-SW-BEIJING"`: 这是我们为新设备设定的**唯一设备ID**。请牢记它。
-   `host`: 替换为您设备的**真实IP地址**或可解析的主机名。
-   `device_type`: 设备的类型。这**必须**是 [Netmiko 库支持的类型](https://github.com/ktbyers/netmiko/blob/develop/README.md#supports)。
    -   常见类型包括: `cisco_ios`, `cisco_xr`, `juniper_junos`, `huawei_vrp`, `arista_eos`, `cisco_asa` 等。

### 步骤 3: 保存并重启代理

1.  **保存**您对 `agent.py` 文件的修改。
2.  回到您正在运行代理的终端窗口，按 `Ctrl+C` 停止当前进程。
3.  重新运行启动命令，以加载新的设备配置：
    ```bash
    uvicorn agent:app --reload
    ```

至此，您的本地代理已经知道如何找到并连接您的新设备了。

---

## 第 2 部分：在Web应用界面中创建设备

现在，我们让链踪Web应用知道这个新设备的存在。

### 步骤 1: 打开“添加新设备”窗口

1.  在浏览器中打开链踪Web应用。
2.  导航到**任意一个**已存在的设备详情页面。
3.  在设备切换下拉框的旁边，找到并点击 **“+”** (加号)按钮。

 <!-- 这是一个占位符，实际使用时可以替换为截图 -->

### 步骤 2: 填写设备信息

在弹出的窗口中，填写新设备的信息：

-   **设备 ID**:
    -   **(最关键的一步!)** 输入您在 `agent.py` 的 `DEVICE_MAP` 中设置的那个**完全相同**的ID。
    -   在我们的示例中，这里应该填 `CORE-SW-BEIJING`。

-   **设备名称**:
    -   一个易于理解的友好名称，例如 `北京核心交换机`。

-   **IP 地址**:
    -   填写设备的真实IP地址，例如 `10.0.0.1`。此IP主要用于在界面上显示。

-   **设备类型**:
    -   从下拉菜单中选择一个最符合的类型（路由器、交换机、防火墙）。

### 步骤 3: 完成添加

点击**“添加设备”**按钮。

---

## ✅ 验证与完成

操作完成后，您会看到：
1.  您的新设备会立即出现在设备切换的下拉列表中。
2.  系统会自动为该设备创建一个“创世区块”作为其配置历史的起点。
3.  您可以立即开始管理这台新设备了！

**强烈建议：** 切换到您的新设备，然后点击**“从设备获取”**按钮来测试整个链路是否工作正常。如果配置被成功拉取到文本框中，恭喜您，添加成功！

## 🔧 故障排除

-   **问题**: 点击“从设备获取”时提示 `Device ID not found` 或 `设备ID未在agent.py中配置`。
    -   **解决方案**: 检查Web应用中显示的设备ID是否与`agent.py`中`DEVICE_MAP`的键**完全一致**（区分大小写）。确认您已经**重启了本地代理**。

-   **问题**: 提示 `连接超时` 或 `认证失败`。
    -   **解决方案**:
        1.  确认`agent.py`中的`host` IP地址是否正确，并且运行代理的电脑可以访问到该IP。
        2.  检查项目文件夹下的 `.env` 文件，确认 `DEVICE_USERNAME` 和 `DEVICE_PASSWORD` 是否正确。
        3.  检查是否有网络防火墙阻止了从代理到设备的SSH连接（默认端口22）。
